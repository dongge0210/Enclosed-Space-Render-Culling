name: è‡ªåŠ¨å‘å¸ƒ | Auto Release

on:
  # æ¯å‘¨ä¸€æ¬¡ (æ¯å‘¨ä¸€ UTC 00:00) - è‡ªåŠ¨å‘å¸ƒweeklyç‰ˆæœ¬
  schedule:
    - cron: '0 0 * * 1'
  
  # æ‰‹åŠ¨è§¦å‘ - æ”¯æŒé€‰æ‹©ä¸åŒå‘å¸ƒç±»å‹
  workflow_dispatch:
    inputs:
      release_type:
        description: 'å‘å¸ƒç±»å‹ | Release Type'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - beta
        - release
      cleanup_old:
        description: 'æ¸…ç†æ—§ç‰ˆæœ¬ | Cleanup Old Releases'
        required: true
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
    - name: æ£€å‡ºä»£ç  | Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿ç”Ÿæˆç‰ˆæœ¬å·

    - name: è®¾ç½®JDK 17 | Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # ç¼“å­˜Gradleä¾èµ–
    - name: ç¼“å­˜Gradleä¾èµ– | Cache Gradle Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

    - name: æ„å»ºMod | Build Minecraft Mod
      run: ./gradlew build --no-daemon --parallel

    # ç”Ÿæˆç‰ˆæœ¬å·å’Œæ ‡ç­¾
    - name: ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯ | Generate Version Info
      id: version
      run: |
        # è·å–å½“å‰æ—¥æœŸå’Œæ—¶é—´
        DATE=$(date +%Y%m%d)
        TIME=$(date +%H%M)
        
        # è·å–çŸ­commit hash
        COMMIT_HASH=$(git rev-parse --short HEAD)
        
        # ä»gradle.propertiesè·å–modç‰ˆæœ¬
        MOD_VERSION=$(grep 'mod_version=' gradle.properties | cut -d'=' -f2)
        
        # æ ¹æ®è§¦å‘ç±»å‹ç¡®å®šå‘å¸ƒç±»å‹
        if [ "${{ github.event_name }}" == "schedule" ]; then
          RELEASE_TYPE="weekly"
          VERSION_TAG="v${MOD_VERSION}-weekly-${DATE}"
          RELEASE_NAME="ğŸ—“ï¸ æ¯å‘¨è‡ªåŠ¨æ„å»º | Weekly Build ${DATE}"
          IS_PRERELEASE="true"
        elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          if [ "$RELEASE_TYPE" == "release" ]; then
            VERSION_TAG="v${MOD_VERSION}"
            RELEASE_NAME="ğŸš€ æ­£å¼ç‰ˆæœ¬ | Release v${MOD_VERSION}"
            IS_PRERELEASE="false"
          elif [ "$RELEASE_TYPE" == "beta" ]; then
            VERSION_TAG="v${MOD_VERSION}-beta-${DATE}"
            RELEASE_NAME="ğŸ§ª æµ‹è¯•ç‰ˆæœ¬ | Beta v${MOD_VERSION}-${DATE}"
            IS_PRERELEASE="true"
          else
            VERSION_TAG="v${MOD_VERSION}-dev-${DATE}-${TIME}"
            RELEASE_NAME="ğŸ”§ å¼€å‘ç‰ˆæœ¬ | Dev Build ${DATE}-${TIME}"
            IS_PRERELEASE="true"
          fi
        else
          RELEASE_TYPE="dev"
          VERSION_TAG="v${MOD_VERSION}-dev-${DATE}-${TIME}-${COMMIT_HASH}"
          RELEASE_NAME="ğŸ”§ å¼€å‘ç‰ˆæœ¬ | Dev Build ${DATE}-${TIME}"
          IS_PRERELEASE="true"
        fi
        
        echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
        echo "release_name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
        echo "is_prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
        echo "mod_version=${MOD_VERSION}" >> $GITHUB_OUTPUT
        echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
        echo "release_type=${RELEASE_TYPE}" >> $GITHUB_OUTPUT

    # æ£€æŸ¥æ˜¯å¦æœ‰jaræ–‡ä»¶ç”Ÿæˆ
    - name: éªŒè¯æ„å»ºäº§ç‰© | Verify Build Artifacts
      run: |
        if [ ! -d "build/libs" ] || [ -z "$(ls -A build/libs/*.jar 2>/dev/null)" ]; then
          echo "âŒ æ²¡æœ‰æ‰¾åˆ°æ„å»ºçš„jaræ–‡ä»¶ | No jar files found!"
          exit 1
        fi
        echo "âœ… æ‰¾åˆ°ä»¥ä¸‹jaræ–‡ä»¶ | Found jar files:"
        ls -la build/libs/*.jar

    # ç”Ÿæˆå‘å¸ƒè¯´æ˜
    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜ | Generate Release Notes
      id: release_notes
      run: |
        # ç¡®å®šæ¸…ç†çŠ¶æ€
        CLEANUP_STATUS="false"
        if [ "${{ github.event_name }}" != "workflow_dispatch" ] || [ "${{ github.event.inputs.cleanup_old }}" == "true" ]; then
          CLEANUP_STATUS="true"
        fi
        
        cat > release_notes.md << EOF
        ## ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯ | Version Information
        
        - **Modç‰ˆæœ¬ | Mod Version**: \`${{ steps.version.outputs.mod_version }}\`
        - **å‘å¸ƒç±»å‹ | Release Type**: \`${{ steps.version.outputs.release_type }}\`
        - **æäº¤å“ˆå¸Œ | Commit Hash**: \`${{ steps.version.outputs.commit_hash }}\`
        - **æ„å»ºæ—¶é—´ | Build Time**: \`$(date -u +"%Y-%m-%d %H:%M:%S UTC")\`
        - **æ—§ç‰ˆæœ¬æ¸…ç† | Old Versions Cleanup**: \`${CLEANUP_STATUS}\`
        
        ## ğŸ® å…¼å®¹æ€§ä¿¡æ¯ | Compatibility Information
        
        - **Minecraftç‰ˆæœ¬ | Minecraft Version**: \`$(grep 'minecraft_version=' gradle.properties | cut -d'=' -f2)\`
        - **Forgeç‰ˆæœ¬ | Forge Version**: \`$(grep 'forge_version=' gradle.properties | cut -d'=' -f2)\`
        - **Createç‰ˆæœ¬ | Create Version**: \`$(grep 'create_version=' gradle.properties | cut -d'=' -f2)\`
        
        ## ğŸ“‹ æ„å»ºæ–‡ä»¶ | Build Files
        
        \`\`\`
        $(ls -la build/libs/)
        \`\`\`
        
        ## ğŸ“ æœ€è¿‘æ›´æ”¹ | Recent Changes
        
        $(git log --oneline -10)
        
        ---
        
        > **æ³¨æ„ | Note**: 
        > - è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„ç‰ˆæœ¬ | This is an automatically generated release
        > - å¦‚æœå¯ç”¨äº†æ¸…ç†åŠŸèƒ½ï¼ŒåŒç±»å‹çš„æ—§ç‰ˆæœ¬å·²è¢«åˆ é™¤ | If cleanup is enabled, old releases of the same type have been deleted
        > - å¦‚æœæ˜¯å¼€å‘ç‰ˆæˆ–æµ‹è¯•ç‰ˆï¼Œè¯·è°¨æ…åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ | If it's a dev or beta version, please use with caution in production
        EOF

    # åˆ é™¤ä¹‹å‰çš„åŒç±»å‹release (æ›´æ¿€è¿›çš„æ¸…ç†ç­–ç•¥)
    - name: æ¸…ç†æ—§ç‰ˆæœ¬ | Cleanup Old Releases
      # åªåœ¨ä»¥ä¸‹æƒ…å†µæ‰§è¡Œæ¸…ç†ï¼š
      # 1. è‡ªåŠ¨è§¦å‘(push/schedule)æ—¶æ€»æ˜¯æ¸…ç†
      # 2. æ‰‹åŠ¨è§¦å‘ä¸”ç”¨æˆ·é€‰æ‹©æ¸…ç†æ—¶
      if: |
        github.event_name != 'workflow_dispatch' || 
        (github.event_name == 'workflow_dispatch' && github.event.inputs.cleanup_old == 'true')
      continue-on-error: true
      run: |
        echo "ğŸ—‘ï¸ å¼€å§‹æ¸…ç†æ—§ç‰ˆæœ¬ | Starting cleanup of old releases..."
        echo "ğŸ”§ æ¸…ç†ç­–ç•¥ | Cleanup strategy: åˆ é™¤æ‰€æœ‰åŒç±»å‹æ—§ç‰ˆæœ¬ | Delete all old releases of same type"
        
        # è·å–æ‰€æœ‰releases
        RELEASES=$(gh release list --limit 100 || echo "")
        
        if [ "${{ steps.version.outputs.release_type }}" == "dev" ]; then
          # åˆ é™¤æ‰€æœ‰æ—§çš„devç‰ˆæœ¬
          echo "ğŸ” æœç´¢å¹¶åˆ é™¤æ‰€æœ‰æ—§çš„devç‰ˆæœ¬ | Searching and deleting all old dev releases..."
          echo "$RELEASES" | grep "dev" | while read release_line; do
            TAG=$(echo "$release_line" | awk '{print $1}')
            if [ "$TAG" != "${{ steps.version.outputs.version_tag }}" ]; then
              echo "ğŸ—‘ï¸ åˆ é™¤devç‰ˆæœ¬ | Deleting dev release: $TAG"
              gh release delete "$TAG" --yes || true
              # åˆ é™¤å¯¹åº”çš„git tag
              git push --delete origin "$TAG" 2>/dev/null || true
            fi
          done
          
        elif [ "${{ steps.version.outputs.release_type }}" == "weekly" ]; then
          # åˆ é™¤æ‰€æœ‰æ—§çš„weeklyç‰ˆæœ¬
          echo "ğŸ” æœç´¢å¹¶åˆ é™¤æ‰€æœ‰æ—§çš„weeklyç‰ˆæœ¬ | Searching and deleting all old weekly releases..."
          echo "$RELEASES" | grep "weekly" | while read release_line; do
            TAG=$(echo "$release_line" | awk '{print $1}')
            if [ "$TAG" != "${{ steps.version.outputs.version_tag }}" ]; then
              echo "ğŸ—‘ï¸ åˆ é™¤weeklyç‰ˆæœ¬ | Deleting weekly release: $TAG"
              gh release delete "$TAG" --yes || true
              # åˆ é™¤å¯¹åº”çš„git tag
              git push --delete origin "$TAG" 2>/dev/null || true
            fi
          done
          
        elif [ "${{ steps.version.outputs.release_type }}" == "beta" ]; then
          # åˆ é™¤æ‰€æœ‰æ—§çš„betaç‰ˆæœ¬
          echo "ğŸ” æœç´¢å¹¶åˆ é™¤æ‰€æœ‰æ—§çš„betaç‰ˆæœ¬ | Searching and deleting all old beta releases..."
          echo "$RELEASES" | grep "beta" | while read release_line; do
            TAG=$(echo "$release_line" | awk '{print $1}')
            if [ "$TAG" != "${{ steps.version.outputs.version_tag }}" ]; then
              echo "ğŸ—‘ï¸ åˆ é™¤betaç‰ˆæœ¬ | Deleting beta release: $TAG"
              gh release delete "$TAG" --yes || true
              # åˆ é™¤å¯¹åº”çš„git tag
              git push --delete origin "$TAG" 2>/dev/null || true
            fi
          done
          
        elif [ "${{ steps.version.outputs.release_type }}" == "release" ]; then
          # å¯¹äºæ­£å¼ç‰ˆæœ¬ï¼Œåªåˆ é™¤åŒç‰ˆæœ¬å·çš„é¢„å‘å¸ƒç‰ˆæœ¬
          MOD_VERSION="${{ steps.version.outputs.mod_version }}"
          echo "ğŸ” åˆ é™¤åŒç‰ˆæœ¬å·çš„é¢„å‘å¸ƒç‰ˆæœ¬ | Deleting pre-releases of same version: $MOD_VERSION"
          echo "$RELEASES" | grep -E "${MOD_VERSION}-(dev|beta|weekly)" | while read release_line; do
            TAG=$(echo "$release_line" | awk '{print $1}')
            echo "ğŸ—‘ï¸ åˆ é™¤é¢„å‘å¸ƒç‰ˆæœ¬ | Deleting pre-release: $TAG"
            gh release delete "$TAG" --yes || true
            # åˆ é™¤å¯¹åº”çš„git tag
            git push --delete origin "$TAG" 2>/dev/null || true
          done
        fi
        
        echo "âœ… æ—§ç‰ˆæœ¬æ¸…ç†å®Œæˆ | Old releases cleanup completed"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # æ£€æŸ¥å¹¶åˆ é™¤å·²å­˜åœ¨çš„åŒåtag
    - name: æ¸…ç†åŒåæ ‡ç­¾ | Cleanup Existing Tags
      continue-on-error: true
      run: |
        TAG="${{ steps.version.outputs.version_tag }}"
        
        # æ£€æŸ¥tagæ˜¯å¦å­˜åœ¨
        if git rev-parse --verify "refs/tags/$TAG" >/dev/null 2>&1; then
          echo "ğŸ·ï¸ å‘ç°å·²å­˜åœ¨çš„æ ‡ç­¾ï¼Œæ­£åœ¨åˆ é™¤ | Found existing tag, deleting: $TAG"
          
          # å…ˆå°è¯•åˆ é™¤è¿œç¨‹release
          gh release delete "$TAG" --yes || true
          
          # åˆ é™¤è¿œç¨‹tag
          git push --delete origin "$TAG" || true
          
          # åˆ é™¤æœ¬åœ°tag
          git tag -d "$TAG" || true
          
          echo "âœ… æ ‡ç­¾æ¸…ç†å®Œæˆ | Tag cleanup completed"
        else
          echo "â„¹ï¸ æœªå‘ç°åŒåæ ‡ç­¾ | No existing tag found: $TAG"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # åˆ›å»ºæˆ–æ›´æ–°Release
    - name: åˆ›å»º/æ›´æ–°Release | Create/Update Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version_tag }}
        name: ${{ steps.version.outputs.release_name }}
        body_path: release_notes.md
        files: build/libs/*.jar
        prerelease: ${{ steps.version.outputs.is_prerelease }}
        make_latest: ${{ steps.version.outputs.is_prerelease == 'false' }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # è¾“å‡ºæˆåŠŸä¿¡æ¯
    - name: å‘å¸ƒå®Œæˆ | Release Complete
      run: |
        echo "ğŸ‰ å‘å¸ƒæˆåŠŸ! | Release successful!"
        echo "ğŸ“¦ ç‰ˆæœ¬æ ‡ç­¾ | Version Tag: ${{ steps.version.outputs.version_tag }}"
        echo "ğŸ”— Releaseé“¾æ¥ | Release URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version_tag }}"
