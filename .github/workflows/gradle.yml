name: Java CI for Minecraft Mod

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # ç¼“å­˜Gradleä¾èµ–,åŠ é€Ÿæ„å»º
    - name: ç¼“å­˜Gradleä¾èµ–
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

    # ForgeGradleè¯ä¹¦æ ¡éªŒå…³æ‰,é˜²æ­¢å›½å†…æ„å»ºæŠ½é£...è¿™ä¼¼ä¹æ²¡å¿…è¦
    #- name: å…³é—­ForgeGradleè¯ä¹¦æ ¡éªŒ
    #  run: echo "ORG_GRADLE_PROJECT_net_forgegradle_gradle_check_certs=false" >> $GITHUB_ENV

    - name: æ„å»ºMod | Build Minecraft Mod
      run: ./gradlew build --no-daemon -info --max-workers=12 --parallel

    - name: ä¸Šä¼ æ„å»ºäº§ç‰© | Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: minecraft-mod-jar
        path: build/libs/*.jar
        if-no-files-found: error

    # ç”Ÿæˆé¡¹ç›®ç›®å½•æ ‘ | Generate Project Directory Tree
    - name: ç”Ÿæˆé¡¹ç›®ç›®å½•æ ‘ | Generate Project Directory Tree
      run: |
        echo "## ğŸ“ é¡¹ç›®ç›®å½•ç»“æ„ | Project Directory Structure" > directory-tree.md
        echo "" >> directory-tree.md
        echo "ğŸ•’ ç”Ÿæˆæ—¶é—´ | Generated at: $(date)" >> directory-tree.md
        echo "" >> directory-tree.md
        echo '```' >> directory-tree.md
        if command -v tree &> /dev/null; then
          tree -a -I '.git|.gradle|build|run|.idea|*.iml|*.ipr|*.iws|logs|mods|*.log' --dirsfirst
        else
          find . -type f -not -path './.git/*' -not -path './.gradle/*' -not -path './build/*' -not -path './run/*' -not -path './.idea/*' | sort
        fi >> directory-tree.md
        echo '```' >> directory-tree.md
        echo "" >> directory-tree.md
        echo "## æ„å»ºä¿¡æ¯ | Build Information" >> directory-tree.md
        echo "- Minecraftç‰ˆæœ¬ | Minecraft Version: $(grep 'minecraft_version=' gradle.properties | cut -d'=' -f2)" >> directory-tree.md
        echo "- Forgeç‰ˆæœ¬ | Forge Version: $(grep 'forge_version=' gradle.properties | cut -d'=' -f2)" >> directory-tree.md
        echo "- Createç‰ˆæœ¬ | Create Version: $(grep 'create_version=' gradle.properties | cut -d'=' -f2)" >> directory-tree.md
        echo "- Modç‰ˆæœ¬ | Mod Version: $(grep 'mod_version=' gradle.properties | cut -d'=' -f2)" >> directory-tree.md
        echo "" >> directory-tree.md
        echo "## æ„å»ºæ–‡ä»¶ | Build Files" >> directory-tree.md
        echo '```' >> directory-tree.md
        ls -la build/libs/ || echo "No build files found"
        echo '```' >> directory-tree.md
        cat directory-tree.md

    - name: ä¸Šä¼ ç›®å½•æ ‘ | Upload Directory Tree
      uses: actions/upload-artifact@v4
      with:
        name: project-directory-tree
        path: directory-tree.md

  dependency-submission:
    runs-on: ubuntu-latest
    # ç¡®ä¿æƒé™æ­£ç¡®é…ç½®
    permissions:
      contents: read
      actions: read
      security-events: write
      # æ·»åŠ ä¾èµ–å›¾æäº¤æ‰€éœ€æƒé™
      pull-requests: read

    steps:
    - uses: actions/checkout@v4
    - name: è®¾ç½®JDK 17 | Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # æ³¨æ„:éœ€è¦åœ¨GitHubä»“åº“è®¾ç½®ä¸­å¯ç”¨Dependency GraphåŠŸèƒ½
    # Note: Dependency Graph feature must be enabled in GitHub repository settings
    - name: ç”Ÿæˆå¹¶æäº¤ä¾èµ–å›¾ | Generate and Submit Dependency Graph
      uses: gradle/actions/dependency-submission@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0
      continue-on-error: true # å¦‚æœä¾èµ–å›¾æœªå¯ç”¨åˆ™è·³è¿‡,ä¸å½±å“æ„å»º | Skip if dependency graph is not enabled
