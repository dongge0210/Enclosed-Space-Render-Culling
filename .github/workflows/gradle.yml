name: Java CI for Minecraft Mod

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # ç¼“å­˜Gradleä¾èµ–,åŠ é€Ÿæ„å»º
    - name: ç¼“å­˜Gradleä¾èµ–
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

    # ForgeGradleè¯ä¹¦æ ¡éªŒå…³æ‰,é˜²æ­¢å›½å†…æ„å»ºæŠ½é£...è¿™ä¼¼ä¹æ²¡å¿…è¦
    #- name: å…³é—­ForgeGradleè¯ä¹¦æ ¡éªŒ
    #  run: echo "ORG_GRADLE_PROJECT_net_forgegradle_gradle_check_certs=false" >> $GITHUB_ENV

    - name: æ„å»ºMod
      run: ./gradlew build --no-daemon -info --max-workers=12 --parallel

    - name: ä¸Šä¼ jaräº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: mod-jar
        path: build/libs/*.jar

    # ç”Ÿæˆé¡¹ç›®ç›®å½•æ ‘
    - name: ç”Ÿæˆé¡¹ç›®ç›®å½•æ ‘
      run: |
        echo "## ğŸ“ é¡¹ç›®ç›®å½•ç»“æ„" > directory-tree.md
        echo "" >> directory-tree.md
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> directory-tree.md
        echo "" >> directory-tree.md
        echo '```' >> directory-tree.md
        if command -v tree &> /dev/null; then
          tree -a -I '.git|.gradle|build|run|.idea|*.iml|*.ipr|*.iws|logs|mods|*.log' --dirsfirst
        else
          find . -type f -not -path './.git/*' -not -path './.gradle/*' -not -path './build/*' -not -path './run/*' -not -path './.idea/*' | sort
        fi >> directory-tree.md
        echo '```' >> directory-tree.md
        echo "" >> directory-tree.md
        echo "## ğŸ“‹ æ„å»ºä¿¡æ¯" >> directory-tree.md
        echo "- Minecraftç‰ˆæœ¬: $(grep 'minecraft_version=' gradle.properties | cut -d'=' -f2)" >> directory-tree.md
        echo "- Forgeç‰ˆæœ¬: $(grep 'forge_version=' gradle.properties | cut -d'=' -f2)" >> directory-tree.md
        echo "- Createç‰ˆæœ¬: $(grep 'create_version=' gradle.properties | cut -d'=' -f2)" >> directory-tree.md
        echo "- Modç‰ˆæœ¬: $(grep 'mod_version=' gradle.properties | cut -d'=' -f2)" >> directory-tree.md
        cat directory-tree.md

    - name: ä¸Šä¼ ç›®å½•æ ‘
      uses: actions/upload-artifact@v4
      with:
        name: directory-tree
        path: directory-tree.md

  dependency-submission:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      security-events: write

    steps:
    - uses: actions/checkout@v4
    - name: è®¾ç½®JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # æ³¨æ„ï¼šéœ€è¦åœ¨GitHubä»“åº“è®¾ç½®ä¸­å¯ç”¨Dependency GraphåŠŸèƒ½
    - name: ç”Ÿæˆå¹¶æäº¤ä¾èµ–å›¾
      uses: gradle/actions/dependency-submission@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0
      continue-on-error: true # å¦‚æœä¾èµ–å›¾æœªå¯ç”¨åˆ™è·³è¿‡ï¼Œä¸å½±å“æ„å»º
